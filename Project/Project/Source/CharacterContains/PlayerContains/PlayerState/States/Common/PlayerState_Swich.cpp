#include"PlayerState_Swich.h"
#include"../../../../../WorldContains/EventMessage/EventMessage.h"
#include"../../../../../Utility/MathSupport/MathSupport.h"


//コンストラクタ
PlayerState_Swich::PlayerState_Swich(const PlayerPtr& player, IGameManagerPtr gameManager)
	:PlayerState(player, gameManager)
	,m_Flag(false){
}

//各状態独自の初期化
void PlayerState_Swich::unique_init()
{
	m_Flag = false;
}

//更新処理
void PlayerState_Swich::update(float deltaTaime)
{
	if (m_Flag == true) {
		change(PlayerStateName::Rounds);
	}
	else {
		change(PlayerStateName::Close);
	}
}

//衝突判定
void PlayerState_Swich::collide(const Actor& other)
{
	//フラグ
	bool flag = false;
	//自分の方向ベクトル
	GSvector2 tmp = p_Player->getBody()->forward();
	tmp.normalize();


	//相手のベクトル
	GSvector2 v = other.getPosition() - p_Player->getPosition();
	v.normalize();
	//自分と相手のベクトルからなす角を取る
	float l_result1 = tmp.innerDegree(v);
	//視野角内(30度)にいるか？
	if (l_result1 <= 30.0f) {
		flag = true;
	}

	if (m_Children[ActorName::Player_Arm]->isCollide(other) && flag == true) {
		m_Flag = true;
		//相手に挟んだ情報を送る
		p_Player->getWorld()->sendMessage(EventMessage::PLAYER_ROUNDS, const_cast<Actor&>(other));
	}
}